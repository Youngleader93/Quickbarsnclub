rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // FONCTIONS HELPER
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'super_admin';
    }

    function isClubAdmin() {
      return isAuthenticated() && getUserData().role == 'club_admin';
    }

    function isServeur() {
      return isAuthenticated() && getUserData().role == 'serveur';
    }

    function hasAccessToEtablissement(etablissementId) {
      return isSuperAdmin() ||
             (isClubAdmin() && etablissementId in getUserData().clubAccess) ||
             (isServeur() && etablissementId in getUserData().clubAccess);
    }

    // ============================================
    // VALIDATION DES COMMANDES
    // ============================================

    function isValidOrderCreate() {
      let data = request.resource.data;

      // Vérifier les champs obligatoires
      return data.keys().hasAll(['number', 'items', 'subtotal', 'tip', 'total', 'status', 'timestamp'])
        // Numéro de commande format A123
        && data.number.matches('^[A-Z][0-9]{3}$')
        // Items est une liste non vide
        && data.items is list
        && data.items.size() > 0
        && data.items.size() <= 50
        // Montants valides
        && data.subtotal is number
        && data.subtotal >= 0
        && data.tip is number
        && data.tip >= 0
        && data.total is number
        && data.total >= 0
        && data.total <= 10000
        // Statut initial doit être pending
        && data.status == 'pending'
        // Vérifier cohérence montants (avec tolérance arrondi)
        && data.total >= data.subtotal
        && data.total <= data.subtotal + data.tip + 0.02;
    }

    function isValidOrderUpdate() {
      let data = request.resource.data;
      let existingData = resource.data;

      // Seuls certains champs peuvent être modifiés
      return data.number == existingData.number
        && data.items == existingData.items
        && data.subtotal == existingData.subtotal
        && data.tip == existingData.tip
        && data.total == existingData.total
        // Statut peut changer vers les états suivants
        && data.status in ['pending', 'in_preparation', 'ready', 'delivered'];
    }

    // ============================================
    // COLLECTION: users
    // ============================================
    match /users/{userId} {
      // Lecture: Utilisateur peut lire son propre doc OU Super Admin peut tout lire
      allow read: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());

      // Création/Modification: Seulement Super Admin
      allow create, update: if isSuperAdmin();

      // Suppression: Seulement Super Admin (changé de false pour permettre la gestion)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // COLLECTION: etablissements
    // ============================================
    match /etablissements/{etablissementId} {
      // Lecture: Public (clients doivent voir les infos de l'établissement)
      allow read: if true;

      // Création: Seulement Super Admin
      allow create: if isSuperAdmin();

      // Modification: Super Admin OU Club Admin avec accès
      allow update: if hasAccessToEtablissement(etablissementId);

      // Suppression: Seulement Super Admin
      allow delete: if isSuperAdmin();

      // ========================================
      // SOUS-COLLECTION: menu
      // ========================================
      match /menu/{itemId} {
        // Lecture: Public (clients doivent voir le menu)
        allow read: if true;

        // Écriture: Seulement admins avec accès à cet établissement
        allow create, update, delete: if hasAccessToEtablissement(etablissementId);
      }

      // ========================================
      // SOUS-COLLECTION: commandes
      // ========================================
      match /commandes/{commandeId} {
        // Création: Public MAIS avec validation stricte des données
        // Note: Pour une sécurité maximale, utiliser Cloud Functions
        allow create: if isValidOrderCreate();

        // Lecture: Public (clients voient leurs commandes + staff voit toutes)
        allow read: if true;

        // Modification: Seulement admins/serveurs avec accès (pour changer statut)
        // Avec validation que seul le statut change
        allow update: if hasAccessToEtablissement(etablissementId) && isValidOrderUpdate();

        // Suppression: Seulement Super Admin
        allow delete: if isSuperAdmin();
      }
    }

    // ============================================
    // COLLECTION: club_requests
    // ============================================
    match /club_requests/{requestId} {
      // Création: Public (formulaire d'inscription ouvert)
      // Validation basique des données
      allow create: if request.resource.data.keys().hasAll(['nom', 'email', 'telephone', 'status'])
                    && request.resource.data.status == 'pending';

      // Lecture/Modification/Suppression: Seulement Super Admin
      allow read, update, delete: if isSuperAdmin();
    }

    // ============================================
    // COLLECTION: rate_limits (pour Cloud Functions)
    // ============================================
    match /rate_limits/{limitId} {
      // Accès uniquement via Cloud Functions (admin SDK)
      allow read, write: if false;
    }

    // ============================================
    // BLOCAGE PAR DÉFAUT
    // ============================================
    // Toute autre collection non mentionnée est bloquée
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
